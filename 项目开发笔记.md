## 项目目录
|-- jobs-chat
    |-- 省略
    |-- src
        |-- config.js
        |-- component // 组件文件夹
        |   |-- logo
            |   |-- job.png
            |   |-- logo.css
            |   |-- logo.js
        |-- container  // 页面文件夹
        |   |-- login // 登录
        |   |-- register // 注册
        |-- index.js
        |-- reducer.js
        |-- redux
## 登录注册
* 页面文件结构

* 开发模式 》 基于cookie用户验证（cookie类似于一张身份卡，登录后服务器端返回，你带着cookie就可以访问受限资源）
> express依赖cookie-parser，需要npm i cookie-parser --save安装

* 登录注册基本页面构建（login.js/register.js）

* 添加对应跳转路由
```js
// index.js
import Login from './container/login/login'
import Register from './container/register/register'
// ...
  <Route path='/login' component={Login}/>
  <Route path='/register' component={Register}/>
```

* 检测路由
```js
// index.js
import AuthRoute from './component/authroute/authroute'
// ...
<AuthRoute />
// 获取用户信息，判断是否已经登录，跳转对应页面
```

* 后端接口
```js
// jobs-chat/server/user.js
const express = require('express')
const Router = express.Router()

// 用户列表
Router.get('/list',function(req,res){
  // 清空用户信息
})

// 用户登录
Router.post('/login', function(req, res){
  // console.log(req.body)
})

// 用户注册
Router.post('/register',function(req,res){
  console.log(req.body)
})

// 用户信息
Router.get('/info',function(req,res){
  // 用户有没有cookie
})

module.exports = Router

```

* 用户信息校验，跳转登录
```js
// jobs-chat/src/component/authroute/authroute.js
import { withRouter } from 'react-router-dom'
@withRouter
// 通过使用@withRouter可以获取到this.props.history、this.props.location相关信息
```

* 注册交互实现

* 注册请求发送
```js
// user.redux.js
// reducer
// 注册
export function register({user,pwd,repeatpwd,type}){
  if (!user || !pwd || !type) {
    return errorMsg('用户名密码必须输入')
  }
  if (pwd !== repeatpwd) {
    return errorMsg('密码与确认密码不一致')
  }
  return dispatch=>{
    axios.post('/user/register',{user,pwd,type})
      .then(res=>{
        if(res.status===200&&res.data.code===0){
          dispatch(registerSuccess({user,pwd,type}))
        }else {
          dispatch(errorMsg(res.data.msg))
        }
      })
  }
}

```

* 数据库模型建立
```js
// jobs-chat/server/model.js
const mongoose = require('mongoose')

//连接Mongo，并且使用data这个集合
const DB_URL = 'mongodb://admin:admin123@ds155864.mlab.com:55864/job-chat'; //mongodb://localhost:27017
mongoose.connect(DB_URL)
mongoose.connection.on('connected', function () {
  console.log('数据库连接成功')
})

const models = {
  user: {
    'user': {'type': String, 'require': true},
    'pwd': {'type': String, 'require': true},
    'type': {'type': String, 'require': true},
    // 头像
    'avatar': {'type': String},
    // 个人简介或职位简介
    'desc': {'type': String},
    // 职位名
    'title': {'type': String},
    // 如果你是boss 还需这两个字段
    'company': {'type': String},
    'money': {'type': String}
  },
  chat: {

  }
}

for(let m in models){
  mongoose.model(m,new mongoose.Schema(models[m]))
}

module.exports = {
  getModel: function(name){
    return mongoose.model(name)
  }
}

// ================================
// jobs-chat/server/user.js
// 引入查询用户列表
const model = require('./model')
const User = model.getModel('user')

// 用户列表
Router.get('/list',function(req,res){
  // 清空用户信息
  // User.remove({}, function(e,d){})
  User.find({},function(err,doc) {
    return res.json(doc)
  })
})
```

* express注册功能实现
`npm install body-parser --save`
> body-parser是非常常用的一个express中间件，作用是对post请求的请求体进行解析。
```js
// jobs-chat/server/server.js
const bodyParser = require('body-parser')

// 新建app
const app = express()
app.use(bodyParser.json())
```
[https://www.cnblogs.com/chyingp/p/nodejs-learning-express-body-parser.html](https://www.cnblogs.com/chyingp/p/nodejs-learning-express-body-parser.html)

* 注册前后端联调

* 注册跳转 密码加密实现
```js
// user.redux.js
import {getRedirectPath} from '../util'

// 用户初始状态
const initState = {
  redirectTo: '',
  // ...
}

redirectTo: getRedirectPath(action.payload)

// =============================
// util.js
// 工具函数
export function getRedirectPath({type,avatar}){
  // 根据用户信息 返回跳转地址
  // user.type /boss /genius
  // user.avatar /bossinfo /geniusinfo
  let url = (type==='boss')?'/boss':'/genius'
  if(!avatar){
    url += 'info'
  }
  return url
}

// =================================
// user.js 使用CMD5进行密码加密 官网：www.cmd5.com
const utils = require('utility')

pwd: md5Pwd(pwd)

function md5Pwd(pwd){
  // 加盐
  const salt = 'react_job_app_@#$%*()+-~~'
  return utils.md5(utils.md5(pwd+salt))
}

```

[web后台接口开发（Express + mongodb）](https://www.jianshu.com/p/d4d275b5d06d)

* cookie保存登录状态
```js
// 后端服务
// jobs-chat/server/user.js
// 用户登录
Router.post('/login', function(req, res){
  // ...
  User.findOne({user, pwd: md5Pwd(pwd)},{'pwd': 0},function(err,doc){
    // ...
    // 添加cookie
    res.cookie('userid', doc.id)
    return res.json({code:0, data: doc})
  })
})

// 根据cookie判断显示
Router.get('/info',function(req,res){
  // 用户有没有cookie
  return res.json({code:1})
})
// 修改为
Router.get('/info',function(req,res){
  // 用户有没有cookie
  const {userid} = req.cookies
  if(!userid) {
    return res.json({code:1})
  }
  User.findOne({_id:userid}, _filter, function(err,doc) {
    if(err) {
      return res.json({code: 1, msg: '服务出错'})
    }
    if(doc) {
      return res.json({code: 0, data: doc})
    }
  })
})

// =============================
// redux用户信息存储
// user.redux.js
const LOAD_DATA = 'LOAD_DATA'

export function user(state = initState, action) {
  switch(action.type){
    // ...
    case LOAD_DATA:
      return {...state, ...action.payload}
    // ...
  }
}

// =============================
// authroute.js
import { loadData } from '../../redux/user.redux'
import { connect } from 'react-redux'

@withRouter
@connect(
  null,
  { loadData }
)

// ...
axios.get('/user/info')
.then(res=>{
  if(res.status === 200) {
    if(res.data.code === 0) {
      // 有登录的信息
      this.props.loadData(res.data.data)
    } else {
      // ...
    }
  }
})

// =============================
// user.redux.js
// 加载数据
const LOAD_DATA = 'LOAD_DATA'

export function loadData(userinfo) {
  return {type: LOAD_DATA, payload: userinfo}
}

// =============================
// user.js
// 修改用户注册部分
const userModel = new User({user,type,pwd:md5Pwd(pwd)})
userModel.save(function(e,d) {
  if(e) {
    return res.json({
      code: 1,
      msg: '网络问题'
    })
  }
  const {user,type,_id} = d
  res.cookie('userid',_id)
  return res.json({code:0,data:{user,type,_id}})
})
```
## boss信息完善页面
* 1. 添加跳转
```js
// jobs-chat/src/index.js
import BossInfo from './container/bossinfo/bossinfo'
// ...
<Route path='/bossinfo' component={BossInfo}/>
```
2. 新建bossinfo
```js
// jobs-chat/src/container/bossinfo/bossinfo.js
import React from 'react'

class BossInfo extends React.Component{
  render() {
    return (
      <div>
        {/* 省略 */}
        <AvatarSelector selectAvatar={(imgname) => {this.setState({avatar: imgname})}}></AvatarSelector>
      </div>
    )
  }
}

export default BossInfo

```
* 3. 头像
```js
// jobs-chat/src/component/avatar-selector/avatar-selector.js

// 头像列表

// 头像显示

// 父子组件数据传递 this.props.selectAvatar(elm.text)
// ...
  <Grid
    data={avatarList}
    columnNum={5}
    onClick={elm=> {
      this.setState(elm)
      this.props.selectAvatar(elm.text)
    }}
  />
// ...
```
* 4. 保存信息到redux
```js
// jobs-chat/src/container/bossinfo/bossinfo.js
import { connect } from 'react-redux'
import { update } from '../../redux/user.redux'

@connect(
  state=>state.user,
  {update}
)

// 省略...
  render() {
    return (
      <div>
        {/* 省略 */}
        <Button type="primary" className="save-btn" style={{marginTop: 20}} onClick={()=> this.props.update(this.state)}>保存</Button>
      </div>
    )
  }

// =======================================
// user.redux.js
const AUTH_SUCCESS = 'AUTH_SUCCESS'

// ...
    case AUTH_SUCCESS:
      return {...state, msg: '', redirectTo: getRedirectPath(action.payload), ...action.payload}
//...

function authSuccess (data) {
  return {
    type: AUTH_SUCCESS,
    payload: data
  }
}
// 上传数据
export function update(data) {
  return dispatch=> {
    axios.post('/user/update', data)
      .then((res) => {
        if(res.status===200 && res.data.code===0){
          // registerSuccess
          dispatch(authSuccess(res.data.data))
        }else {
          dispatch(errorMsg(res.data.msg))
        }
      })
  }
}

```
* 5. update后端接口实现
```js
// jobs-chat/server/user.js
// 用户信息上传
Router.post('/update', function(req, res) {
  const userid = req.cookies.userid
  if(!userid) {
    // 将对象转换为 JSON 字符串
    return json.dumps({code: 1})
  }
  const body = req.body
  User.findByIdAndUpdate(userid,body,function(err,doc) {
    const data = Object.assign({}, {
      user: doc.user,
      type: doc.type
    }, body)
    return res.json({code: 0, data})
  })
})

// ==================================
// bossinfo.js
// 跳转设置
  render() {
    const path = this.props.location.pathname
    const redirect = this.props.redirectTo
    return (
      <div>
        {redirect && redirect !== path ? <Redirect to={this.props.redirectTo}></Redirect> : null}
        {/* 省略 */}
      </div>
    )
  }
```
## 求职者信息
* 1. 添加路由
```js
// jobs-chat/src/index.js
import GeniusInfo from './container/geniusinfo/geniusinfo'
// ...
  <Switch>
    <Route path='/bossinfo' component={BossInfo}/>
    <Route path='/geniusinfo' component={GeniusInfo}/>
    <Route path='/login' component={Login}/>
    <Route path='/register' component={Register}/>
  </Switch>
```
* 2. 求职者信息页面
```js
// jobs-chat/src/container/geniusinfo/geniusinfo.js
// 参考bossinfo.js
```
* 3. 使用 PropTypes 进行类型检查
```js
import PropTypes from 'prop-types';
// ...
static propsTypes = {
  selectAvatar: PropTypes.func.isRequired
}
```
[使用 PropTypes 进行类型检查参考文档](https://zh-hans.reactjs.org/docs/typechecking-with-proptypes.html#gatsby-focus-wrapper)
## BOSS列表
```js
// src/index.js
<Route component={Dashboard}/>
```
## 求职者列表
* 1. 引入genius.js
```js
// dashboard.js
import Genius from '../../component/genius/genius'

// ===============================================
// genius.js
import React from 'react'

import {
  Card,
  WhiteSpace,
  WingBlank
} from 'antd-mobile'
import {connect} from 'react-redux'
import {getUserList} from '../../redux/chatuser.redux'

@connect(
  state=>state.chatuser,
  {getUserList}
)
class Genius extends React.Component{
	componentDidMount() {
    this.props.getUserList('boss')
  }

  render() {
    console.log(this.state)
    // return null
    const Header = Card.Header
    const Body = Card.Body
    return (
      <div>
        <h2>求职者首页，查看boss列表</h2>
      </div>
    )
  }
}
export default Genius

```
* 2. 抽离列表信息卡片展示部分
```js
// jobs-chat/src/component/usercard/usercard.js
import React from 'react'
import PropTypes from 'prop-types'
import {
  Card,
  WhiteSpace,
  WingBlank
} from 'antd-mobile'

class UserCard extends React.Component{
  static propTypes = {
    userlist: PropTypes.array.isRequired
  }

  render() {
    const Header = Card.Header
    const Body = Card.Body
    return (
      <WingBlank>
        <WhiteSpace />
        {this.props.userlist.map(v => (v.avatar ? (<Card key={v._id}>
            <Header
              title={v.user}
              thumb={require(`../img/${v.avatar}.png`)}
              extra={<span>{v.title}</span>}
            ></Header>
            <Body>
              {v.type === 'boss' ? <div>公司： {v.company}</div> : null}
              {v.desc.split('\n').map(d=>(
                <div key={d}>{d}</div>
              ))}
              {v.type === 'boss' ? <div>薪资： {v.money}</div> : null}
            </Body>
          </Card>) : null
        ))}
      </WingBlank>
    )
  }
}

export default UserCard

```
* 3. 更新求职者列表
```js
// genius.js
import React from 'react'
import {connect} from 'react-redux'
import {getUserList} from '../../redux/chatuser.redux'
import UserCard from '../usercard/usercard'

@connect(
  state=>state.chatuser,
  {getUserList}
)
class Genius extends React.Component{
	componentDidMount() {
    this.props.getUserList('boss')
  }

  render() {
    return <UserCard userlist={this.props.userlist}></UserCard>
  }
}
export default Genius

```
## 个人中心
* 1. 更新个人中心引入
```js
// dashboard.js
import User from '../../component/user/user'
```
* 2. 个人中心页面
```js
// user.js
import React from 'react'
import {connect} from 'react-redux'
import {
  Result,
  List,
  WhiteSpace
} from 'antd-mobile'

@connect(
  state=>state.user
)
class User extends React.Component{
  render() {
    // console.log(this.props)
    const props = this.props
    const Item = List.Item
    const Brief = Item.Brief
    return props.user ? (
      <div>
        <Result
          img={<img src={require(`../img/${props.avatar}.png`)} style={{width: 50}} alt={props.avatar} />}
          title={props.user}
          message={props.type==='boss' ? props.company : null}
        />
        <List renderHeader={() => '简介'} className="my-list">
          <Item multipleLine>
            {props.title}
            {props.desc.split('\n').map(v=><Brief key={v}>{v}</Brief>)}
            {props.money ? <Brief>薪资： {props.money}</Brief> : null}
          </Item>
        </List>
        <WhiteSpace></WhiteSpace>
        <List>
          <Item>退出登录</Item>
        </List>
      </div>
    ) : null
  }
}

export default User
```
## 退出登录
* 1. 清除cookie登录状态
```
>> 安装browser-cookies
>> npm install browser-cookies
```
```js
// user.js
import browserCookie from 'browser-cookies'
// 退出登录
  logout() {
    // 退出登录确认弹框
    const alert = Modal.alert
    alert('注销', '确认退出登录吗???', [
      { text: '取消', onPress: () => console.log('cancel') },
      { text: '确认', onPress: () => {
        browserCookie.erase('userid')
        // 刷新页面
        // window.location.href = window.location.href
      }}
    ])
    // console.log('退出')
  }
```
* 2. 注销时清空redux数据
```js
// user.js
import {logoutSubmit} from '../../redux/user.redux'

@connect(
  state=>state.user,
  {logoutSubmit}
)

// ...
this.props.logoutSubmit()

// ============================
// Redux清空用户登录数据
// jobs-chat/src/redux/user.redux.js
const LOGOUT = 'LOGOUT'
// ...
    case LOGOUT:
      return {...initState, redirectTo: '/login'}
// ...
// 退出登录
export function logoutSubmit() {
  return {type: LOGOUT}
}
```
* 3. 跳转登录页面
```js
// user.js
import {Redirect} from 'react-router-dom'
// ...
<Redirect to={props.redirectTo} />
```
## 聊天
* 1. Socket.io
* 2. 添加路由
```js
// index.js
import Chat from './component/chat/chat'
// ...
<Route path='/chat/:user' component={Chat}/>
```
* 3. 聊天页面
```js
// chat.js
import React from 'react'

class Chat extends React.Component{
  render() {
    console.log(this.props)
    return (
      <h2>chat with user: {this.props.match.params.user}</h2>
    )
  }
}

export default Chat

```
* 4. 引用
```js
// usercard.js
import {withRouter} from 'react-router-dom'

@withRouter
class UserCard extends React.Component{
  // ...
  <Card key={v._id} onClick={()=>this.handleClick(v)}>
}
```
* 5. 服务端socket.io的使用
```js
// server.js
const server = require('http').Server(app)
const io = require('socket.io')(server)

io.on('connection', function(socket) {
  console.log('用户登录')
})

```
* 6. 发送信息
```js
// chat.js
import io from 'socket.io-client'
// ...
  componentDidMount() {
    const socket = io('ws://localhost:5000')
  }

```
* 7. 后端接收消息
```js
// server.js
io.on('connection', function(socket) {
  // console.log('用户登录')
  // 监听客户端发送的信息
  socket.on('sendmsg', function (data) {
    console.log(data)
    // 发送信息到全局
    io.emit('recvmsg', data)
  })
})

```
* 8. 前端获取消息
```js
// chat.js
  componentDidMount() {
    // 获取一下信息
    socket.on('recvmsg', function (data) {
      console.log(data)
    })
  }
// =======================================
// 显示消息
    socket.on('recvmsg', (data) => {
      // console.log(data)
      this.setState({
        msg: [...this.state.msg, data.text]
      })
    })

{this.state.msg.map(v=>{return <p key={v}>{v}</p>})}
```
* 9. 聊天信息入库（数据库）
```js
// model.js
// 聊天模型
  chat: {
    'chatid': {'type': String, 'require': true},
    'from': {'type': String, 'require': true},
    'to': {'type': String, 'require': true},
    'read': {'type': Boolean, 'default': false},
    'content': {'type': String, 'require': true, 'default': ''},
    'create_time': {'type': Number, 'default': new Date().getTime()},
  }
```
* 10. 聊天Redux
```js
// chat.redux.js
import axios from 'axios'
import io from 'socket.io-client'
const socket = io('ws://localhost:5000')

// 获取聊天列表
const MSG_LIST = 'MSG_LIST'
// 读取信息
const MSG_RECV = 'MSG_RECV'
// 标识已读
const MSG_READ = 'MSG_READ'

const initState = {
  chatmsg: [],
  unread: 0
}

export function chat(state=initState, action) {
  switch(action.type) {
    case MSG_LIST:
      // unread未读（过滤已读）
      return {...state, chatmsg: action.payload, unread: action.payload.filter(v=>!v.read).length}
    // case MSG_RECV:

    // case MSG_READ:

    default:
      return state
  }
}

function msgList(msgs) {
  return {type: 'MSG_LIST', payload: msgs}
}

export function getMsgList() {
  return dispatch => {
    axios.get('/user/getmsglist')
      .then(res=>{
        if(res.state===200 && res.data.code===0) {
          dispatch(msgList(res.data.msgs))
        }
      })
  }
}
```
* 11. 引用chat.redux.js
```js
// chat.js
import {connect} from 'react-redux'
import {getMsgList} from '../../redux/chat.redux'

@connect(
  state=>state,
  {getMsgList}
)
class Chat extends React.Component{
  // ...
  componentDidMount() {
    // 获取一下信息
    this.props.getMsgList()
  }
  // ...
}
```
* 12. 服务端接口实现
```js
// jobs-chat/server/user.js
// 引入聊天数据模型
const Chat = model.getModel('chat')

// 获取聊天列表
Router.get('/getmsglist', function (req, res) {
  // const user = req.cookies.user
  // {'$or':[{from:user, to:user}]}
  Chat.find({}, function(err, doc) {
    if(!err){
      return res.json({code:0, msg: doc})
    }
  })
})
```
* 13. 聊天页面发送信息
```js
// chat.js
import {
  getMsgList,
  sendMsg
} from '../../redux/chat.redux'

@connect(
  state=>state,
  {
    getMsgList,
    sendMsg
  }
)
// ...
  handleSubmit() {
    const from = this.props.user._id
    const to = this.props.match.params.user
    const msg = this.state.text
    this.props.sendMsg(from,to,msg)
    this.setState({text: ''})
  }
```
* 14. 聊天redux添加对应sendMsg方法
```js
// chat.redux.js
export function sendMsg(from, to, msg) {
  return dispatch => {
    socket.emit('sendmsg', {
      from,
      to,
      msg
    })
  }
}

```
* 15. 聊天数据入库
```js
// server.js
const model = require('./model')
// 引入聊天数据模型
const Chat = model.getModel('chat')

io.on('connection', function(socket) {
  // console.log('用户登录')
  // 监听客户端发送的信息
  socket.on('sendmsg', function (data) {
    // console.log('返回信息：', data)
    // 发送信息到全局
    // io.emit('recvmsg', data)
    const {from, to, msg} = data
    const chatid = [from, to].sort().join('_')
    // console.log(chatid)
    Chat.create({chatid, from, to, content: msg}, function(err, doc) {
      io.emit('recvmsg', Object.assign({}, doc._doc))
    })
  })
})

```
* 16. 聊天头像显示
```js
// user.js

Router.get('/getmsglist', function (req, res) {
  const user = req.cookies.userid
  // 查询用户信息
  User.find({}, function(e, userdoc) {
    let users = {}
    // 遍历获取用户昵称及头像
    userdoc.forEach(v=> {
      users[v._id] = {name: v.user, avatar: v.avatar}
    })

    Chat.find({'$or':[{from:user}, {to:user}]}, function(err, doc) {
      if(!err){
        return res.json({code:0, msgs: doc, users: users})
      }
    })
  })
})

// chat.redux.js
const initState = {
  // ...
  users: {},
  // ...
}

// chat.js
  componentDidMount() {
    // 获取一下信息
    if(!this.props.chat.chatmsg.length) {
      this.props.getMsgList()
      this.props.recvMsg()
    }
  }
// ...
```
* 17. 聊天消息显示修正
