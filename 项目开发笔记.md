## 项目目录
|-- jobs-chat
    |-- 省略
    |-- src
        |-- config.js
        |-- component // 组件文件夹
        |   |-- logo
            |   |-- job.png
            |   |-- logo.css
            |   |-- logo.js
        |-- container  // 页面文件夹
        |   |-- login // 登录
        |   |-- register // 注册
        |-- index.js
        |-- reducer.js
        |-- redux
## 登录注册
* 页面文件结构

* 开发模式 》 基于cookie用户验证（cookie类似于一张身份卡，登录后服务器端返回，你带着cookie就可以访问受限资源）
> express依赖cookie-parser，需要npm i cookie-parser --save安装

* 登录注册基本页面构建（login.js/register.js）

* 添加对应跳转路由
```js
// index.js
import Login from './container/login/login'
import Register from './container/register/register'
// ...
  <Route path='/login' component={Login}/>
  <Route path='/register' component={Register}/>
```

* 检测路由
```js
// index.js
import AuthRoute from './component/authroute/authroute'
// ...
<AuthRoute />
// 获取用户信息，判断是否已经登录，跳转对应页面
```

* 后端接口
```js
// jobs-chat/server/user.js
const express = require('express')
const Router = express.Router()

// 用户列表
Router.get('/list',function(req,res){
  // 清空用户信息
})

// 用户登录
Router.post('/login', function(req, res){
  // console.log(req.body)
})

// 用户注册
Router.post('/register',function(req,res){
  console.log(req.body)
})

// 用户信息
Router.get('/info',function(req,res){
  // 用户有没有cookie
})

module.exports = Router

```

* 用户信息校验，跳转登录
```js
// jobs-chat/src/component/authroute/authroute.js
import { withRouter } from 'react-router-dom'
@withRouter
// 通过使用@withRouter可以获取到this.props.history、this.props.location相关信息
```

* 注册交互实现

* 注册请求发送
```js
// user.redux.js
// reducer
// 注册
export function register({user,pwd,repeatpwd,type}){
  if (!user || !pwd || !type) {
    return errorMsg('用户名密码必须输入')
  }
  if (pwd !== repeatpwd) {
    return errorMsg('密码与确认密码不一致')
  }
  return dispatch=>{
    axios.post('/user/register',{user,pwd,type})
      .then(res=>{
        if(res.status===200&&res.data.code===0){
          dispatch(registerSuccess({user,pwd,type}))
        }else {
          dispatch(errorMsg(res.data.msg))
        }
      })
  }
}

```

* 数据库模型建立
```js
// jobs-chat/server/model.js
const mongoose = require('mongoose')

//连接Mongo，并且使用data这个集合
const DB_URL = 'mongodb://admin:admin123@ds155864.mlab.com:55864/job-chat'; //mongodb://localhost:27017
mongoose.connect(DB_URL)
mongoose.connection.on('connected', function () {
  console.log('数据库连接成功')
})

const models = {
  user: {
    'user': {'type': String, 'require': true},
    'pwd': {'type': String, 'require': true},
    'type': {'type': String, 'require': true},
    // 头像
    'avatar': {'type': String},
    // 个人简介或职位简介
    'desc': {'type': String},
    // 职位名
    'title': {'type': String},
    // 如果你是boss 还需这两个字段
    'company': {'type': String},
    'money': {'type': String}
  },
  chat: {

  }
}

for(let m in models){
  mongoose.model(m,new mongoose.Schema(models[m]))
}

module.exports = {
  getModel: function(name){
    return mongoose.model(name)
  }
}

// ================================
// jobs-chat/server/user.js
// 引入查询用户列表
const model = require('./model')
const User = model.getModel('user')

// 用户列表
Router.get('/list',function(req,res){
  // 清空用户信息
  // User.remove({}, function(e,d){})
  User.find({},function(err,doc) {
    return res.json(doc)
  })
})
```

* express注册功能实现
`npm install body-parser --save`
> body-parser是非常常用的一个express中间件，作用是对post请求的请求体进行解析。
```js
// jobs-chat/server/server.js
const bodyParser = require('body-parser')

// 新建app
const app = express()
app.use(bodyParser.json())
```
[https://www.cnblogs.com/chyingp/p/nodejs-learning-express-body-parser.html](https://www.cnblogs.com/chyingp/p/nodejs-learning-express-body-parser.html)

* 注册前后端联调

* 注册跳转 密码加密实现
```js
// user.redux.js
import {getRedirectPath} from '../util'

// 用户初始状态
const initState = {
  redirectTo: '',
  // ...
}

redirectTo: getRedirectPath(action.payload)

// =============================
// util.js
// 工具函数
export function getRedirectPath({type,avatar}){
  // 根据用户信息 返回跳转地址
  // user.type /boss /genius
  // user.avatar /bossinfo /geniusinfo
  let url = (type==='boss')?'/boss':'/genius'
  if(!avatar){
    url += 'info'
  }
  return url
}

// =================================
// user.js 使用CMD5进行密码加密 官网：www.cmd5.com
const utils = require('utility')

pwd: md5Pwd(pwd)

function md5Pwd(pwd){
  // 加盐
  const salt = 'react_job_app_@#$%*()+-~~'
  return utils.md5(utils.md5(pwd+salt))
}

```

[web后台接口开发（Express + mongodb）](https://www.jianshu.com/p/d4d275b5d06d)

* cookie保存登录状态
```js
// 后端服务
// jobs-chat/server/user.js
// 用户登录
Router.post('/login', function(req, res){
  // ...
  User.findOne({user, pwd: md5Pwd(pwd)},{'pwd': 0},function(err,doc){
    // ...
    // 添加cookie
    res.cookie('userid', doc.id)
    return res.json({code:0, data: doc})
  })
})

// 根据cookie判断显示
Router.get('/info',function(req,res){
  // 用户有没有cookie
  return res.json({code:1})
})
// 修改为
Router.get('/info',function(req,res){
  // 用户有没有cookie
  const {userid} = req.cookies
  if(!userid) {
    return res.json({code:1})
  }
  User.findOne({_id:userid}, _filter, function(err,doc) {
    if(err) {
      return res.json({code: 1, msg: '服务出错'})
    }
    if(doc) {
      return res.json({code: 0, data: doc})
    }
  })
})

// =============================
// redux用户信息存储
// user.redux.js
const LOAD_DATA = 'LOAD_DATA'

export function user(state = initState, action) {
  switch(action.type){
    // ...
    case LOAD_DATA:
      return {...state, ...action.payload}
    // ...
  }
}

// =============================
// authroute.js
import { loadData } from '../../redux/user.redux'
import { connect } from 'react-redux'

@withRouter
@connect(
  null,
  { loadData }
)

// ...
axios.get('/user/info')
.then(res=>{
  if(res.status === 200) {
    if(res.data.code === 0) {
      // 有登录的信息
      this.props.loadData(res.data.data)
    } else {
      // ...
    }
  }
})

// =============================
// user.redux.js
// 加载数据
const LOAD_DATA = 'LOAD_DATA'

export function loadData(userinfo) {
  return {type: LOAD_DATA, payload: userinfo}
}

// =============================
// user.js
// 修改用户注册部分
const userModel = new User({user,type,pwd:md5Pwd(pwd)})
userModel.save(function(e,d) {
  if(e) {
    return res.json({
      code: 1,
      msg: '网络问题'
    })
  }
  const {user,type,_id} = d
  res.cookie('userid',_id)
  return res.json({code:0,data:{user,type,_id}})
})
```
## boss信息完善页面
* 1. 添加跳转
```js
// jobs-chat/src/index.js
import BossInfo from './container/bossinfo/bossinfo'
// ...
<Route path='/bossinfo' component={BossInfo}/>
```
2. 新建bossinfo
```js
// jobs-chat/src/container/bossinfo/bossinfo.js
import React from 'react'

class BossInfo extends React.Component{
  render() {
    return (
      <div>
        {/* 省略 */}
        <AvatarSelector selectAvatar={(imgname) => {this.setState({avatar: imgname})}}></AvatarSelector>
      </div>
    )
  }
}

export default BossInfo

```
* 3. 头像
```js
// jobs-chat/src/component/avatar-selector/avatar-selector.js

// 头像列表

// 头像显示

// 父子组件数据传递 this.props.selectAvatar(elm.text)
// ...
  <Grid
    data={avatarList}
    columnNum={5}
    onClick={elm=> {
      this.setState(elm)
      this.props.selectAvatar(elm.text)
    }}
  />
// ...
```
* 4. 保存信息到redux
```js
// jobs-chat/src/container/bossinfo/bossinfo.js
import { connect } from 'react-redux'
import { update } from '../../redux/user.redux'

@connect(
  state=>state.user,
  {update}
)

// 省略...
  render() {
    return (
      <div>
        {/* 省略 */}
        <Button type="primary" className="save-btn" style={{marginTop: 20}} onClick={()=> this.props.update(this.state)}>保存</Button>
      </div>
    )
  }

// =======================================
// user.redux.js
const AUTH_SUCCESS = 'AUTH_SUCCESS'

// ...
    case AUTH_SUCCESS:
      return {...state, msg: '', redirectTo: getRedirectPath(action.payload), ...action.payload}
//...

function authSuccess (data) {
  return {
    type: AUTH_SUCCESS,
    payload: data
  }
}
// 上传数据
export function update(data) {
  return dispatch=> {
    axios.post('/user/update', data)
      .then((res) => {
        if(res.status===200 && res.data.code===0){
          // registerSuccess
          dispatch(authSuccess(res.data.data))
        }else {
          dispatch(errorMsg(res.data.msg))
        }
      })
  }
}

```
* 5. update后端接口实现
```js
// jobs-chat/server/user.js
// 用户信息上传
Router.post('/update', function(req, res) {
  const userid = req.cookies.userid
  if(!userid) {
    // 将对象转换为 JSON 字符串
    return json.dumps({code: 1})
  }
  const body = req.body
  User.findByIdAndUpdate(userid,body,function(err,doc) {
    const data = Object.assign({}, {
      user: doc.user,
      type: doc.type
    }, body)
    return res.json({code: 0, data})
  })
})

// ==================================
// bossinfo.js
// 跳转设置
  render() {
    const path = this.props.location.pathname
    const redirect = this.props.redirectTo
    return (
      <div>
        {redirect && redirect !== path ? <Redirect to={this.props.redirectTo}></Redirect> : null}
        {/* 省略 */}
      </div>
    )
  }
```
## 求职者信息
* 1. 添加路由
```js
// jobs-chat/src/index.js
import GeniusInfo from './container/geniusinfo/geniusinfo'
// ...
  <Switch>
    <Route path='/bossinfo' component={BossInfo}/>
    <Route path='/geniusinfo' component={GeniusInfo}/>
    <Route path='/login' component={Login}/>
    <Route path='/register' component={Register}/>
  </Switch>
```
* 2. 求职者信息页面
```js
// jobs-chat/src/container/geniusinfo/geniusinfo.js
// 参考bossinfo.js
```
* 3. 使用 PropTypes 进行类型检查
```js
import PropTypes from 'prop-types';
// ...
static propsTypes = {
  selectAvatar: PropTypes.func.isRequired
}
```
[使用 PropTypes 进行类型检查参考文档](https://zh-hans.reactjs.org/docs/typechecking-with-proptypes.html#gatsby-focus-wrapper)
